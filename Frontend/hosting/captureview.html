<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title>Space Snap View</title>
    <meta name="description" content="360&deg; Image - A-Frame">
    <link rel="stylesheet" href="capture.css">
    <script src="aframe-master.js"></script>
    <script>
        AFRAME.registerComponent('alert-on-click', {
            init: function () {
                this.el.addEventListener('click', function (evt) {
                    myclickhandler();
                });
            }
        });
    </script>
    <script>

        document.addEventListener('DOMContentLoaded', function () {
            loadProps();
        });

        function loadProps() {
            var props = getURL();
            if (props.background){
                var sky = document.querySelector('a-sky');
                console.log('have background', props.background);
                switch(props.background) {
                    case "0":
                        sky.setAttribute("src","#iss")
                        break;
                    case "1":
                        sky.setAttribute("src","#moon")
                        break;
                    case "2":
                        sky.setAttribute("src","#mars")
                        break;
                    case "21":
                        sky.setAttribute("src","#mars2")
                        break;
                    default:
                        // code block
                }
            }
        }


        function myclickhandler() {
            var sceneCanvas = document.querySelector('a-scene').components.screenshot.getCanvas('perspective');

            var sourceX = sceneCanvas.width / 4;
            var sourceY = sceneCanvas.height / 4;
            var sourceWidth = sceneCanvas.width/2;
            var sourceHeight = sceneCanvas.height/2;
            var destWidth = 0;
            var destHeight = 0;
            var outWidth = sceneCanvas.width / 2;
            var outHeight = sceneCanvas.height/2;

            var offscreenCanvas = document.createElement('canvas');
            offscreenCanvas.width = outWidth;
            offscreenCanvas.height = outHeight;


            var context = offscreenCanvas.getContext('2d');
            context.drawImage(sceneCanvas, sourceX, sourceY, sourceWidth, sourceHeight, destWidth, destHeight, outHeight, outerWidth );

            var dataURL = offscreenCanvas.toDataURL("image/jpg");

            var downloadLink = document.createElement('a');
            downloadLink.href = dataURL;
            downloadLink.download = 'myImage.png';

            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        function sendBlob(blob) {
            console.log(blob);
            // var xmlHttp = new XMLHttpRequest();
            // xmlHttp.open("GET", theUrl, false); // false for synchronous request
            // xmlHttp.send(null);
            // return xmlHttp.responseText;
        }

        function getURL(){
            var vars = {};
            var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
                vars[key] = value;
            });
            return vars;
        }
    </script>
</head>

<body>
    <a-scene>
        <a-assets>
            <img id="iss" src="iss.jpg">
            <img id="moon" src="moon.jpg">
            <img id="mars" src="mars.jpg">
            <img id="mars2" src="mars2.jpg">
        </a-assets>
        <a-sky src="#iss" radius="100" alert-on-click=''></a-sky>
        </a-sky>
        <a-entity id="rig" position="0 0 0">
            <a-entity id="camera" camera look-controls position="0 1.6 0">
                <a-cursor raycaster="objects: a-sky" fuse="false"></a-cursor>
            </a-entity>
        </a-entity>
    </a-scene>
</body>

</html>